# ElectricityMonitorPulse

Particle photon/core firmware to monitor electricity usage and publish to InfluxDB.


## Documentation

The basis of operation is the measurement of the time between LED pulses generated by the electricity metering unit, where duration is proportional to power (see OpenEnergyMonitor  [Monitoring energy via utility meter pulse output](https://learn.openenergymonitor.org/electricity-monitoring/pulse-counting/introduction-to-pulse-counting)). To extend battery life, WiFi connection is managed to reduce device power usage.

### Output

**power**: (Watts) the instantaneous power demand

**elapsedEnergy**: (kWh) energy consumption since midnight

**dailyCost**: (pence) daily energy cost


### Hardware

Connect a Light to Voltage sensor e.g. [TLS257](http://ams.com/eng/Products/Light-Sensors/Light-to-Voltage/TSL257) to  interrupt pin `D3`. The firmware toggles the state of the onboard LED `D7` to provide feedback on the pulse rate.

### Software

The firmware uses an InfluxDB database for recording power data. This is accessed via the author's [InfluxDB Particle Library](https://github.com/richardjlyon/InfluxDB). See the details for naming conventions, etc.

Each flash triggers interrupt handler `flag_pulse()`, which simply sets `pulseFlag` to be `true`. This minimises interrupt handler duration.

In `loop()`, when `pulseFlag` is set, the energy is calculated and added to the InfluxDB buffer with a timestamp, the LED is toggled, and the flag reset. Daily energy cost is calculated from values for `STANDING_CHARGE` (pence per day) and `UNIT_COST` (pence per kWh) from the power contract. The energy totaliser is reset at midnight.

The main part of `loop()` manages the device's WiFi state to reduce power consumption (WiFi is the largest power user on the device). The duration of the cycle is set with `setCycleDuration()` in milliseconds.

At the start of the cycle, WiFi is turned on and the device reconnected. After settling time (empirically set via `WIFI_SETTLING_TIME` and `PUBLISH_SETTLING_TIME`), the InfluxDB buffer is uploaded to InfluxDB with `idb.sendAll()`. Then Wifi is switched off.

In this way, the device stores power data in a low power mode, and connects only periodically (say, every 10 minutes) for the expensive upload operation.

### Authentication

You need authentication credentials for the InfluxDB service. For security, I've omitted these from this. To provide yours, create file `authentication.h` in `src` with the following:

```
#define USERNAME "your_username"
#define PASSWORD "your_password"
```
